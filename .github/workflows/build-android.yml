name: Build Android APK

on:
  workflow_dispatch:
    inputs:
      buildId:
        description: 'Build Job ID'
        required: true
      appId:
        description: 'App ID'
        required: true
      appName:
        description: 'App Name'
        required: true
      websiteUrl:
        description: 'Website URL'
        required: true
      primaryColor:
        description: 'Primary Color (hex)'
        required: true
      secondaryColor:
        description: 'Secondary Color (hex)'
        required: false
        default: '#008556'
      iconUrl:
        description: 'Icon URL'
        required: false
      splashScreenUrl:
        description: 'Splash Screen URL'
        required: false

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Java 11
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'
          cache: 'gradle'

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3
        with:
          api-level: 33
          ndk-version: '25.1.8937393'

      - name: Create build configuration
        run: |
          mkdir -p build-templates/android/config
          cat > build-templates/android/config/build-config.json << 'EOF'
          {
            "buildId": "${{ inputs.buildId }}",
            "appId": "${{ inputs.appId }}",
            "appName": "${{ inputs.appName }}",
            "websiteUrl": "${{ inputs.websiteUrl }}",
            "primaryColor": "${{ inputs.primaryColor }}",
            "secondaryColor": "${{ inputs.secondaryColor }}",
            "iconUrl": "${{ inputs.iconUrl }}",
            "splashScreenUrl": "${{ inputs.splashScreenUrl }}",
            "packageName": "com.b1appbuilder.${{ inputs.appName | replace(' ', '') | lower }}",
            "buildTimestamp": "$(date -u +'%Y-%m-%dT%H:%M:%SZ')"
          }
          EOF
          cat build-templates/android/config/build-config.json

      - name: Update build.gradle
        run: |
          BUILD_DIR="build-templates/android"
          if [ -f "$BUILD_DIR/app/build.gradle" ]; then
            PACKAGE_NAME="com.b1appbuilder.${{ inputs.appName | replace(' ', '') | lower }}"
            sed -i "s/applicationId \"[^\"]*\"/applicationId \"$PACKAGE_NAME\"/g" "$BUILD_DIR/app/build.gradle"
            echo "✓ Updated applicationId to $PACKAGE_NAME"
          else
            echo "⚠ build.gradle not found, skipping update"
          fi

      - name: Update AndroidManifest.xml
        run: |
          BUILD_DIR="build-templates/android"
          MANIFEST_PATH="$BUILD_DIR/app/src/main/AndroidManifest.xml"
          if [ -f "$MANIFEST_PATH" ]; then
            sed -i "s/android:label=\"[^\"]*\"/android:label=\"${{ inputs.appName }}\"/g" "$MANIFEST_PATH"
            echo "✓ Updated app name in manifest"
          else
            echo "⚠ AndroidManifest.xml not found, skipping update"
          fi

      - name: Download app icon
        if: inputs.iconUrl != ''
        continue-on-error: true
        run: |
          mkdir -p build-templates/android/app/src/main/res/mipmap-xxxhdpi
          curl -L -o build-templates/android/app/src/main/res/mipmap-xxxhdpi/ic_launcher.png "${{ inputs.iconUrl }}"
          echo "✓ Icon downloaded"

      - name: Download splash screen
        if: inputs.splashScreenUrl != ''
        continue-on-error: true
        run: |
          mkdir -p build-templates/android/app/src/main/res/drawable
          curl -L -o build-templates/android/app/src/main/res/drawable/splash_screen.png "${{ inputs.splashScreenUrl }}"
          echo "✓ Splash screen downloaded"

      - name: Update colors in resources
        run: |
          BUILD_DIR="build-templates/android"
          COLORS_FILE="$BUILD_DIR/app/src/main/res/values/colors.xml"
          if [ -f "$COLORS_FILE" ]; then
            sed -i "s/<color name=\"primary\">[^<]*<\/color>/<color name=\"primary\">${{ inputs.primaryColor }}<\/color>/g" "$COLORS_FILE"
            sed -i "s/<color name=\"secondary\">[^<]*<\/color>/<color name=\"secondary\">${{ inputs.secondaryColor }}<\/color>/g" "$COLORS_FILE"
            echo "✓ Updated colors in resources"
          else
            echo "⚠ colors.xml not found, skipping color update"
          fi

      - name: Build APK
        run: |
          cd build-templates/android
          chmod +x gradlew
          ./gradlew clean assembleRelease -x lint --stacktrace --info
          echo "✓ APK build completed"

      - name: Verify APK file
        run: |
          APK_PATH="build-templates/android/app/build/outputs/apk/release/app-release.apk"
          if [ -f "$APK_PATH" ]; then
            APK_SIZE=$(du -h "$APK_PATH" | cut -f1)
            echo "✓ APK built successfully: $APK_SIZE"
            ls -lh "$APK_PATH"
            file "$APK_PATH"
          else
            echo "✗ ERROR: APK not found at $APK_PATH"
            find build-templates/android -name "*.apk" -type f
            exit 1
          fi

      - name: Create release keystore
        run: |
          if [ ! -f "release.keystore" ]; then
            keytool -genkey -v -keystore release.keystore \
              -keyalg RSA -keysize 2048 -validity 10000 \
              -alias release-key \
              -storepass android123 -keypass android123 \
              -dname "CN=B1AppBuilder,O=B1,L=Tel Aviv,S=Israel,C=IL"
            echo "✓ Keystore created"
          else
            echo "✓ Keystore already exists"
          fi

      - name: Sign APK
        run: |
          APK_PATH="build-templates/android/app/build/outputs/apk/release/app-release.apk"
          
          jarsigner -verbose -sigalg SHA256withRSA -digestalg SHA-256 \
            -keystore release.keystore \
            -storepass android123 -keypass android123 \
            "$APK_PATH" release-key
          
          echo "✓ APK signed successfully"

      - name: Verify APK signature
        run: |
          APK_PATH="build-templates/android/app/build/outputs/apk/release/app-release.apk"
          jarsigner -verify -verbose -certs "$APK_PATH"
          echo "✓ APK signature verified"

      - name: Generate download URL
        id: upload
        run: |
          BUILD_ID="${{ inputs.buildId }}"
          DOWNLOAD_URL="https://storage.b1appbuilder.com/$BUILD_ID/app-release.apk"
          echo "download_url=$DOWNLOAD_URL" >> $GITHUB_OUTPUT
          echo "✓ Download URL: $DOWNLOAD_URL"

      - name: Notify backend - Build Complete
        if: success()
        continue-on-error: true
        run: |
          curl -X POST "${{ secrets.BACKEND_URL }}/api/trpc/builds.completeBuild" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.BACKEND_API_KEY }}" \
            -d '{
              "buildId": "${{ inputs.buildId }}",
              "status": "COMPLETED",
              "androidUrl": "${{ steps.upload.outputs.download_url }}",
              "platform": "ANDROID"
            }' \
            || echo "⚠ Backend notification failed (non-critical)"

      - name: Upload APK artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: app-release-apk
          path: build-templates/android/app/build/outputs/apk/release/app-release.apk
          retention-days: 30

      - name: Upload build logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: build-templates/android/app/build/outputs/
          retention-days: 7

      - name: Notify backend - Build Failed
        if: failure()
        continue-on-error: true
        run: |
          ERROR_MSG="Build failed at step: ${{ job.status }}"
          curl -X POST "${{ secrets.BACKEND_URL }}/api/trpc/builds.failBuild" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.BACKEND_API_KEY }}" \
            -d "{
              \"buildId\": \"${{ inputs.buildId }}\",
              \"error\": \"$ERROR_MSG\"
            }" \
            || echo "⚠ Error notification failed"
