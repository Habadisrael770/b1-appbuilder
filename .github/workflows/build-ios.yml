name: Build iOS IPA

on:
  workflow_dispatch:
    inputs:
      buildId:
        description: 'Build Job ID'
        required: true
      appId:
        description: 'App ID'
        required: true
      appName:
        description: 'App Name'
        required: true
      websiteUrl:
        description: 'Website URL'
        required: true
      primaryColor:
        description: 'Primary Color (hex)'
        required: true
      secondaryColor:
        description: 'Secondary Color (hex)'
        required: false
        default: '#008556'
      iconUrl:
        description: 'Icon URL'
        required: false
      splashScreenUrl:
        description: 'Splash Screen URL'
        required: false

jobs:
  build:
    runs-on: macos-latest
    timeout-minutes: 45
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Create build configuration
        run: |
          mkdir -p build-templates/ios/config
          cat > build-templates/ios/config/build-config.json << 'EOF'
          {
            "buildId": "${{ inputs.buildId }}",
            "appId": "${{ inputs.appId }}",
            "appName": "${{ inputs.appName }}",
            "websiteUrl": "${{ inputs.websiteUrl }}",
            "primaryColor": "${{ inputs.primaryColor }}",
            "secondaryColor": "${{ inputs.secondaryColor }}",
            "iconUrl": "${{ inputs.iconUrl }}",
            "splashScreenUrl": "${{ inputs.splashScreenUrl }}",
            "bundleId": "com.b1appbuilder.${{ inputs.appName | replace(' ', '') | lower }}",
            "buildTimestamp": "$(date -u +'%Y-%m-%dT%H:%M:%SZ')"
          }
          EOF
          cat build-templates/ios/config/build-config.json

      - name: Install CocoaPods dependencies
        run: |
          cd build-templates/ios
          if [ -f "Podfile" ]; then
            pod install --repo-update
            echo "✓ CocoaPods dependencies installed"
          else
            echo "⚠ Podfile not found, skipping pod install"
          fi

      - name: Update Xcode project settings
        run: |
          BUILD_DIR="build-templates/ios"
          BUNDLE_ID="com.b1appbuilder.${{ inputs.appName | replace(' ', '') | lower }}"
          
          if [ -f "$BUILD_DIR/MyApp.xcodeproj/project.pbxproj" ]; then
            sed -i '' "s/PRODUCT_BUNDLE_IDENTIFIER = \"[^\"]*\"/PRODUCT_BUNDLE_IDENTIFIER = \"$BUNDLE_ID\"/g" "$BUILD_DIR/MyApp.xcodeproj/project.pbxproj"
            sed -i '' "s/PRODUCT_NAME = \"[^\"]*\"/PRODUCT_NAME = \"${{ inputs.appName }}\"/g" "$BUILD_DIR/MyApp.xcodeproj/project.pbxproj"
            echo "✓ Updated Xcode project with bundle ID and app name"
          else
            echo "⚠ project.pbxproj not found, skipping update"
          fi

      - name: Download app icon
        if: inputs.iconUrl != ''
        continue-on-error: true
        run: |
          mkdir -p build-templates/ios/MyApp/Assets.xcassets/AppIcon.appiconset
          curl -L -o build-templates/ios/MyApp/Assets.xcassets/AppIcon.appiconset/icon.png "${{ inputs.iconUrl }}"
          echo "✓ Icon downloaded"

      - name: Download splash screen
        if: inputs.splashScreenUrl != ''
        continue-on-error: true
        run: |
          mkdir -p build-templates/ios/MyApp/Assets.xcassets
          curl -L -o build-templates/ios/MyApp/Assets.xcassets/splash.imageset/splash.png "${{ inputs.splashScreenUrl }}"
          echo "✓ Splash screen downloaded"

      - name: Update colors in Info.plist
        run: |
          BUILD_DIR="build-templates/ios"
          PLIST_PATH="$BUILD_DIR/MyApp/Info.plist"
          
          if [ -f "$PLIST_PATH" ]; then
            /usr/libexec/PlistBuddy -c "Set :UIAppPrimaryColor ${{ inputs.primaryColor }}" "$PLIST_PATH" 2>/dev/null || true
            /usr/libexec/PlistBuddy -c "Set :UIAppSecondaryColor ${{ inputs.secondaryColor }}" "$PLIST_PATH" 2>/dev/null || true
            echo "✓ Updated colors in Info.plist"
          else
            echo "⚠ Info.plist not found, skipping color update"
          fi

      - name: Create provisioning profile directory
        run: |
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          echo "✓ Provisioning profile directory created"

      - name: Create signing certificate
        run: |
          CERT_PATH="build-templates/ios/signing/certificate.p12"
          mkdir -p build-templates/ios/signing
          
          openssl req -x509 -newkey rsa:2048 -keyout key.pem -out cert.pem -days 365 -nodes \
            -subj "/C=IL/ST=Israel/L=Tel Aviv/O=B1/CN=B1AppBuilder"
          
          openssl pkcs12 -export -out "$CERT_PATH" -inkey key.pem -in cert.pem \
            -passout pass:b1appbuilder
          
          rm key.pem cert.pem
          echo "✓ Self-signed certificate created"

      - name: Build iOS Archive
        run: |
          cd build-templates/ios
          
          WORKSPACE_PATH="MyApp.xcworkspace"
          SCHEME="MyApp"
          BUILD_DIR="build"
          ARCHIVE_PATH="$BUILD_DIR/MyApp.xcarchive"
          
          if [ -d "$WORKSPACE_PATH" ]; then
            xcodebuild -workspace "$WORKSPACE_PATH" \
              -scheme "$SCHEME" \
              -configuration Release \
              -derivedDataPath "$BUILD_DIR" \
              -archivePath "$ARCHIVE_PATH" \
              archive \
              -allowProvisioningUpdates \
              -verbose
            echo "✓ iOS archive built successfully"
          else
            echo "⚠ Workspace not found, attempting project build"
            xcodebuild -project MyApp.xcodeproj \
              -scheme "$SCHEME" \
              -configuration Release \
              -derivedDataPath "$BUILD_DIR" \
              -archivePath "$ARCHIVE_PATH" \
              archive \
              -allowProvisioningUpdates \
              -verbose
            echo "✓ iOS archive built successfully"
          fi

      - name: Verify Archive
        run: |
          ARCHIVE_PATH="build-templates/ios/build/MyApp.xcarchive"
          if [ -d "$ARCHIVE_PATH" ]; then
            ARCHIVE_SIZE=$(du -sh "$ARCHIVE_PATH" | cut -f1)
            echo "✓ Archive verified: $ARCHIVE_SIZE"
            ls -lh "$ARCHIVE_PATH"
          else
            echo "✗ ERROR: Archive not found at $ARCHIVE_PATH"
            find build-templates/ios -name "*.xcarchive" -type d
            exit 1
          fi

      - name: Export IPA
        run: |
          cd build-templates/ios
          
          ARCHIVE_PATH="build/MyApp.xcarchive"
          EXPORT_PATH="build/export"
          EXPORT_OPTIONS_PLIST="ExportOptions.plist"
          
          if [ ! -f "$EXPORT_OPTIONS_PLIST" ]; then
            cat > "$EXPORT_OPTIONS_PLIST" << 'PLIST'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key>
            <string>ad-hoc</string>
            <key>signingStyle</key>
            <string>automatic</string>
            <key>stripSwiftSymbols</key>
            <true/>
            <key>teamID</key>
            <string>B1APPBUILDER</string>
          </dict>
          </plist>
          PLIST
            echo "✓ ExportOptions.plist created"
          fi
          
          xcodebuild -exportArchive \
            -archivePath "$ARCHIVE_PATH" \
            -exportOptionsPlist "$EXPORT_OPTIONS_PLIST" \
            -exportPath "$EXPORT_PATH" \
            -verbose
          
          echo "✓ IPA exported successfully"

      - name: Verify IPA file
        run: |
          IPA_PATH="build-templates/ios/build/export/MyApp.ipa"
          if [ -f "$IPA_PATH" ]; then
            IPA_SIZE=$(du -h "$IPA_PATH" | cut -f1)
            echo "✓ IPA built successfully: $IPA_SIZE"
            ls -lh "$IPA_PATH"
            file "$IPA_PATH"
          else
            echo "✗ ERROR: IPA not found at $IPA_PATH"
            find build-templates/ios -name "*.ipa" -type f
            exit 1
          fi

      - name: Generate download URL
        id: upload
        run: |
          BUILD_ID="${{ inputs.buildId }}"
          DOWNLOAD_URL="https://storage.b1appbuilder.com/$BUILD_ID/MyApp.ipa"
          echo "download_url=$DOWNLOAD_URL" >> $GITHUB_OUTPUT
          echo "✓ Download URL: $DOWNLOAD_URL"

      - name: Notify backend - Build Complete
        if: success()
        continue-on-error: true
        run: |
          curl -X POST "${{ secrets.BACKEND_URL }}/api/trpc/builds.completeBuild" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.BACKEND_API_KEY }}" \
            -d '{
              "buildId": "${{ inputs.buildId }}",
              "status": "COMPLETED",
              "iosUrl": "${{ steps.upload.outputs.download_url }}",
              "platform": "IOS"
            }' \
            || echo "⚠ Backend notification failed (non-critical)"

      - name: Upload IPA artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: app-release-ipa
          path: build-templates/ios/build/export/MyApp.ipa
          retention-days: 30

      - name: Upload build logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ios-build-logs
          path: build-templates/ios/build/
          retention-days: 7

      - name: Notify backend - Build Failed
        if: failure()
        continue-on-error: true
        run: |
          ERROR_MSG="Build failed at step: ${{ job.status }}"
          curl -X POST "${{ secrets.BACKEND_URL }}/api/trpc/builds.failBuild" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.BACKEND_API_KEY }}" \
            -d "{
              \"buildId\": \"${{ inputs.buildId }}\",
              \"error\": \"$ERROR_MSG\"
            }" \
            || echo "⚠ Error notification failed"
