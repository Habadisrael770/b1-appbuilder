name: Build iOS IPA

on:
  repository_dispatch:
    types: [build-ios]
  workflow_dispatch:
    inputs:
      appId:
        description: 'App ID'
        required: true
      appName:
        description: 'App Name'
        required: true
      websiteUrl:
        description: 'Website URL'
        required: true
      primaryColor:
        description: 'Primary Color (hex)'
        required: true

jobs:
  build:
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: |
          brew install cocoapods
          cd build-templates/ios && pod install --repo-update
      
      - name: Download assets
        run: |
          mkdir -p build-templates/ios/assets
          echo "Assets directory created"
      
      - name: Configure app
        run: |
          chmod +x scripts/configure-ios.sh
          ./scripts/configure-ios.sh "${{ github.event.client_payload.appId }}" "${{ github.event.client_payload.appName }}" "${{ github.event.client_payload.websiteUrl }}" "${{ github.event.client_payload.primaryColor }}"
      
      - name: Import signing certificate
        env:
          BUILD_CERTIFICATE_BASE64: ${{ secrets.IOS_BUILD_CERTIFICATE_BASE64 }}
          P12_PASSWORD: ${{ secrets.IOS_P12_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.IOS_KEYCHAIN_PASSWORD }}
        run: |
          CERTIFICATE_PATH=$RUNNER_TEMP/build_certificate.p12
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          
          echo -n "$BUILD_CERTIFICATE_BASE64" | base64 --decode > $CERTIFICATE_PATH
          
          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          
          security import $CERTIFICATE_PATH -P "$P12_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          security list-keychain -d user -s $KEYCHAIN_PATH
          
          rm $CERTIFICATE_PATH
      
      - name: Import provisioning profile
        env:
          PROVISIONING_PROFILE_BASE64: ${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}
        run: |
          PP_PATH=$RUNNER_TEMP/build_pp.mobileprovision
          echo -n "$PROVISIONING_PROFILE_BASE64" | base64 --decode > $PP_PATH
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp $PP_PATH ~/Library/MobileDevice/Provisioning\ Profiles/
      
      - name: Build archive
        run: |
          cd build-templates/ios
          xcodebuild -workspace MyApp.xcworkspace \
            -scheme MyApp \
            -configuration Release \
            -derivedDataPath build \
            -archivePath build/MyApp.xcarchive \
            archive
      
      - name: Export IPA
        env:
          EXPORT_OPTIONS_PLIST: ${{ secrets.IOS_EXPORT_OPTIONS_PLIST }}
        run: |
          cd build-templates/ios
          
          EXPORT_PLIST=$RUNNER_TEMP/ExportOptions.plist
          echo -n "$EXPORT_OPTIONS_PLIST" | base64 --decode > $EXPORT_PLIST
          
          xcodebuild -exportArchive \
            -archivePath build/MyApp.xcarchive \
            -exportOptionsPlist $EXPORT_PLIST \
            -exportPath build/export
      
      - name: Verify IPA
        run: |
          cd build-templates/ios
          if [ -f "build/export/MyApp.ipa" ]; then
            echo "✅ IPA generated successfully"
            ls -lh build/export/MyApp.ipa
          else
            echo "❌ IPA generation failed"
            exit 1
          fi
      
      - name: Upload to Railway Storage
        run: |
          cd build-templates/ios
          IPA_PATH="build/export/MyApp.ipa"
          
          curl -X POST https://api.railway.app/graphql \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{
              "query": "mutation { artifactCreate(input: {projectId: \"${{ secrets.RAILWAY_PROJECT_ID }}\", content: \"'$(base64 -w 0 < $IPA_PATH)'\"}) { artifact { id url } } }"
            }'
      
      - name: Update database
        run: |
          chmod +x scripts/update-db.sh
          ./scripts/update-db.sh "${{ github.event.client_payload.appId }}" "IOS"
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
      
      - name: Notify backend
        run: |
          curl -X POST http://localhost:3000/api/builds/complete \
            -H "Content-Type: application/json" \
            -d '{
              "appId": "${{ github.event.client_payload.appId }}",
              "platform": "IOS",
              "status": "COMPLETED"
            }'
      
      - name: Upload artifact
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: ios-ipa
          path: build-templates/ios/build/export/
